
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Expectation Data &#8212; web-platform-tests  documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="wptrunner Design" href="design.html" />
    <link rel="prev" title="Getting Started" href="usage.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="expectation-data">
<h1>Expectation Data<a class="headerlink" href="#expectation-data" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>For use in continuous integration systems, and other scenarios where
regression tracking is required, wptrunner supports storing and
loading the expected result of each test in a test run. Typically
these expected results will initially be generated by running the
testsuite in a baseline build. They may then be edited by humans as
new features are added to the product that change the expected
results. The expected results may also vary for a single product
depending on the platform on which it is run. Therefore, the raw
structured log data is not a suitable format for storing these
files. Instead something is required that is:</p>
<blockquote>
<div><ul class="simple">
<li>Human readable</li>
<li>Human editable</li>
<li>Machine readable / writable</li>
<li>Capable of storing test id / result pairs</li>
<li>Suitable for storing in a version control system (i.e. text-based)</li>
</ul>
</div></blockquote>
<p>The need for different results per platform means either having
multiple expectation files for each platform, or having a way to
express conditional values within a certain file. The former would be
rather cumbersome for humans updating the expectation files, so the
latter approach has been adopted, leading to the requirement:</p>
<blockquote>
<div><ul class="simple">
<li>Capable of storing result values that are conditional on the platform.</li>
</ul>
</div></blockquote>
<p>There are few extant formats that meet these requirements, so
wptrunner uses a bespoke <code class="docutils literal notranslate"><span class="pre">expectation</span> <span class="pre">manifest</span></code> format, which is
closely based on the standard <code class="docutils literal notranslate"><span class="pre">ini</span></code> format.</p>
</div>
<div class="section" id="directory-layout">
<h2>Directory Layout<a class="headerlink" href="#directory-layout" title="Permalink to this headline">¶</a></h2>
<p>Expectation manifest files must be stored under the <code class="docutils literal notranslate"><span class="pre">metadata</span></code>
directory passed to the test runner. The directory layout follows that
of web-platform-tests with each test path having a corresponding
manifest file. Tests that differ only by query string, or reftests
with the same test path but different ref paths share the same
reference file. The file name is taken from the last /-separated part
of the path, suffixed with <code class="docutils literal notranslate"><span class="pre">.ini</span></code>.</p>
<p>As an optimisation, files which produce only default results
(i.e. <code class="docutils literal notranslate"><span class="pre">PASS</span></code> or <code class="docutils literal notranslate"><span class="pre">OK</span></code>) don’t require a corresponding manifest file.</p>
<p>For example a test with url:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/spec/section/file.html?query=param
</pre></div>
</div>
<p>would have an expectation file</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">metadata</span><span class="o">/</span><span class="n">spec</span><span class="o">/</span><span class="n">section</span><span class="o">/</span><span class="n">file</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">ini</span>
</pre></div>
</div>
</div>
<div class="section" id="generating-expectation-files">
<span id="wptupdate-label"></span><h2>Generating Expectation Files<a class="headerlink" href="#generating-expectation-files" title="Permalink to this headline">¶</a></h2>
<p>wptrunner provides the tool <code class="docutils literal notranslate"><span class="pre">wptupdate</span></code> to generate expectation
files from the results of a set of baseline test runs. The basic
syntax for this is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wptupdate</span> <span class="p">[</span><span class="n">options</span><span class="p">]</span> <span class="p">[</span><span class="n">logfile</span><span class="p">]</span><span class="o">...</span>
</pre></div>
</div>
<p>Each <code class="docutils literal notranslate"><span class="pre">logfile</span></code> is a structured log file from a previous run. These
can be generated from wptrunner using the <code class="docutils literal notranslate"><span class="pre">--log-raw</span></code> option
e.g. <code class="docutils literal notranslate"><span class="pre">--log-raw=structured.log</span></code>. The default behaviour is to update
all the test data for the particular combination of hardware and OS
used in the run corresponding to the log data, whilst leaving any
other expectations untouched.</p>
<p>wptupdate takes several useful options:</p>
<dl class="docutils">
<dt><code class="docutils literal notranslate"><span class="pre">--sync</span></code></dt>
<dd>Pull the latest version of web-platform-tests from the
upstream specified in the config file. If this is specified in
combination with logfiles, it is assumed that the results in the log
files apply to the post-update tests.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">--no-check-clean</span></code></dt>
<dd>Don’t attempt to check if the working directory is clean before
doing the update (assuming that the working directory is a git or
mercurial tree).</dd>
<dt><code class="docutils literal notranslate"><span class="pre">--patch</span></code></dt>
<dd>Create a a git commit, or a mq patch, with the changes made by wptupdate.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">--ignore-existing</span></code></dt>
<dd>Overwrite all the expectation data for any tests that have a result
in the passed log files, not just data for the same platform.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">--disable-intermittent</span></code></dt>
<dd>When updating test results, disable tests that have inconsistent
results across many runs. This can precede a message providing a
reason why that test is disable. If no message is provided,
<code class="docutils literal notranslate"><span class="pre">unstable</span></code> is the default text.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">--update-intermittent</span></code></dt>
<dd>When this option is used, the <code class="docutils literal notranslate"><span class="pre">expected</span></code> key (see below) stores
expected intermittent statuses in addition to the primary expected
status. If there is more than one status, it appears as a list. The
default behaviour of this option is to retain any existing intermittent
statuses in the list unless <code class="docutils literal notranslate"><span class="pre">--remove-intermittent</span></code> is specified.</dd>
<dt><code class="docutils literal notranslate"><span class="pre">--remove-intermittent</span></code></dt>
<dd>This option is used in conjunction with <code class="docutils literal notranslate"><span class="pre">--update-intermittent</span></code>.
When the <code class="docutils literal notranslate"><span class="pre">expected</span></code> statuses are updated, any obsolete intermittent
statuses that did not occur in the specified logfiles are removed from
the list.</dd>
</dl>
<div class="section" id="examples">
<h3>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h3>
<p>Update the local copy of web-platform-tests without changing the
expectation data and commit (or create a mq patch for) the result:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wptupdate</span> <span class="o">--</span><span class="n">patch</span> <span class="o">--</span><span class="n">sync</span>
</pre></div>
</div>
<p>Update all the expectations from a set of cross-platform test runs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wptupdate</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">check</span><span class="o">-</span><span class="n">clean</span> <span class="o">--</span><span class="n">patch</span> <span class="n">osx</span><span class="o">.</span><span class="n">log</span> <span class="n">linux</span><span class="o">.</span><span class="n">log</span> <span class="n">windows</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>Add expectation data for some new tests that are expected to be
platform-independent:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wptupdate</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">check</span><span class="o">-</span><span class="n">clean</span> <span class="o">--</span><span class="n">patch</span> <span class="o">--</span><span class="n">ignore</span><span class="o">-</span><span class="n">existing</span> <span class="n">tests</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="manifest-format">
<h2>Manifest Format<a class="headerlink" href="#manifest-format" title="Permalink to this headline">¶</a></h2>
<p>The format of the manifest files is based on the ini format. Files are
divided into sections, each (apart from the root section) having a
heading enclosed in square braces. Within each section are key-value
pairs. There are several notable differences from standard .ini files,
however:</p>
<blockquote>
<div><ul class="simple">
<li>Sections may be hierarchically nested, with significant whitespace
indicating nesting depth.</li>
<li>Only <code class="docutils literal notranslate"><span class="pre">:</span></code> is valid as a key/value separator</li>
</ul>
</div></blockquote>
<p>A simple example of a manifest file is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root_key</span><span class="p">:</span> <span class="n">root_value</span>

<span class="p">[</span><span class="n">section</span><span class="p">]</span>
  <span class="n">section_key</span><span class="p">:</span> <span class="n">section_value</span>

  <span class="p">[</span><span class="n">subsection</span><span class="p">]</span>
     <span class="n">subsection_key</span><span class="p">:</span> <span class="n">subsection_value</span>

<span class="p">[</span><span class="n">another_section</span><span class="p">]</span>
  <span class="n">another_key</span><span class="p">:</span> <span class="n">another_value</span>
</pre></div>
</div>
<p>The web-platform-test harness knows about several keys:</p>
<dl class="docutils">
<dt><cite>expected</cite></dt>
<dd>Must evaluate to a possible test status indicating the expected
result of the test. The implicit default is PASS or OK when the
field isn’t present. When <cite>expected</cite> is a list, the first status
is the primary expected status and the trailing statuses listed are
expected intermittent statuses.</dd>
<dt><cite>disabled</cite></dt>
<dd>Any value indicates that the test is disabled.</dd>
<dt><cite>reftype</cite></dt>
<dd>The type of comparison for reftests; either <cite>==</cite> or <cite>!=</cite>.</dd>
<dt><cite>refurl</cite></dt>
<dd>The reference url for reftests.</dd>
</dl>
<div class="section" id="conditional-values">
<h3>Conditional Values<a class="headerlink" href="#conditional-values" title="Permalink to this headline">¶</a></h3>
<p>In order to support values that depend on some external data, the
right hand side of a key/value pair can take a set of conditionals
rather than a plain value. These values are placed on a new line
following the key, with significant indentation. Conditional values
are prefixed with <code class="docutils literal notranslate"><span class="pre">if</span></code> and terminated with a colon, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">key</span><span class="p">:</span>
  <span class="k">if</span> <span class="n">cond1</span><span class="p">:</span> <span class="n">value1</span>
  <span class="k">if</span> <span class="n">cond2</span><span class="p">:</span> <span class="n">value2</span>
  <span class="n">value3</span>
</pre></div>
</div>
<p>In this example, the value associated with <code class="docutils literal notranslate"><span class="pre">key</span></code> is determined by
first evaluating <code class="docutils literal notranslate"><span class="pre">cond1</span></code> against external data. If that is true,
<code class="docutils literal notranslate"><span class="pre">key</span></code> is assigned the value <code class="docutils literal notranslate"><span class="pre">value1</span></code>, otherwise <code class="docutils literal notranslate"><span class="pre">cond2</span></code> is
evaluated in the same way. If both <code class="docutils literal notranslate"><span class="pre">cond1</span></code> and <code class="docutils literal notranslate"><span class="pre">cond2</span></code> are false,
the unconditional <code class="docutils literal notranslate"><span class="pre">value3</span></code> is used.</p>
<p>Conditions themselves use a Python-like expression syntax. Operands
can either be variables, corresponding to data passed in, numbers
(integer or floating point; exponential notation is not supported) or
quote-delimited strings. Equality is tested using <code class="docutils literal notranslate"><span class="pre">==</span></code> and
inequality by <code class="docutils literal notranslate"><span class="pre">!=</span></code>. The operators <code class="docutils literal notranslate"><span class="pre">and</span></code>, <code class="docutils literal notranslate"><span class="pre">or</span></code> and <code class="docutils literal notranslate"><span class="pre">not</span></code> are
used in the expected way. Parentheses can also be used for
grouping. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">key</span><span class="p">:</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">==</span> <span class="s2">&quot;abc&quot;</span><span class="p">:</span> <span class="n">value1</span>
  <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">b</span> <span class="o">!=</span> <span class="s2">&quot;abc&quot;</span><span class="p">:</span> <span class="n">value2</span>
  <span class="n">value3</span>
</pre></div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> are variables, the value of which will be
supplied when the manifest is used.</p>
</div>
</div>
<div class="section" id="expectation-manifests">
<h2>Expectation Manifests<a class="headerlink" href="#expectation-manifests" title="Permalink to this headline">¶</a></h2>
<p>When used for expectation data, manifests have the following format:</p>
<blockquote>
<div><ul class="simple">
<li>A section per test URL described by the manifest, with the section
heading being the part of the test URL following the last <code class="docutils literal notranslate"><span class="pre">/</span></code> in
the path (this allows multiple tests in a single manifest file with
the same path part of the URL, but different query parts).</li>
<li>A subsection per subtest, with the heading being the title of the
subtest.</li>
<li>A key <code class="docutils literal notranslate"><span class="pre">expected</span></code> giving the expectation value or values of each
(sub)test.</li>
<li>A key <code class="docutils literal notranslate"><span class="pre">disabled</span></code> which can be set to any value to indicate that
the (sub)test is disabled and should either not be run (for tests)
or that its results should be ignored (subtests).</li>
<li>A key <code class="docutils literal notranslate"><span class="pre">restart-after</span></code> which can be set to any value to indicate that
the runner should restart the browser after running this test (e.g. to
clear out unwanted state).</li>
<li>A key <code class="docutils literal notranslate"><span class="pre">fuzzy</span></code> that is used for reftests. This is interpreted as a
list containing entries like <code class="docutils literal notranslate"><span class="pre">&lt;meta</span> <span class="pre">name=fuzzy&gt;</span></code> content value,
which consists of an optional reference identifier followed by a
colon, then a range indicating the maximum permitted pixel
difference per channel, then semicolon, then a range indicating the
maximum permitted total number of differing pixels. The reference
identifier is either a single relative URL, resolved against the
base test URL, in which case the fuzziness applies to any
comparison with that URL, or takes the form lhs url, comparison,
rhs url, in which case the fuzziness only applies for any
comparison involving that specifc pair of URLs. Some illustrative
examples are given below.</li>
<li>Variables <code class="docutils literal notranslate"><span class="pre">debug</span></code>, <code class="docutils literal notranslate"><span class="pre">os</span></code>, <code class="docutils literal notranslate"><span class="pre">version</span></code>, <code class="docutils literal notranslate"><span class="pre">processor</span></code> and
<code class="docutils literal notranslate"><span class="pre">bits</span></code> that describe the configuration of the browser under
test. <code class="docutils literal notranslate"><span class="pre">debug</span></code> is a boolean indicating whether a build is a debug
build. <code class="docutils literal notranslate"><span class="pre">os</span></code> is a string indicating the operating system, and
<code class="docutils literal notranslate"><span class="pre">version</span></code> a string indicating the particular version of that
operating system. <code class="docutils literal notranslate"><span class="pre">processor</span></code> is a string indicating the
processor architecture and <code class="docutils literal notranslate"><span class="pre">bits</span></code> an integer indicating the
number of bits. This information is typically provided by
<a class="reference external" href="https://firefox-source-docs.mozilla.org/mozbase/mozinfo.html#module-mozinfo" title="(in Mozilla Source Tree Docs v71.0)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">mozinfo</span></code></a>.</li>
<li>Top level keys are taken as defaults for the whole file. So, for
example, a top level key with <code class="docutils literal notranslate"><span class="pre">expected:</span> <span class="pre">FAIL</span></code> would indicate
that all tests and subtests in the file are expected to fail,
unless they have an <code class="docutils literal notranslate"><span class="pre">expected</span></code> key of their own.</li>
</ul>
</div></blockquote>
<p>An simple example manifest might look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[test.html?variant=basic]
  type: testharness

  [Test something unsupported]
     expected: FAIL

  [Test with intermittent statuses]
     expected: [PASS, TIMEOUT]

[test.html?variant=broken]
  expected: ERROR

[test.html?variant=unstable]
  disabled: http://test.bugs.example.org/bugs/12345
</pre></div>
</div>
<p>A more complex manifest with conditional properties might be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">canvas_test</span><span class="o">.</span><span class="n">html</span><span class="p">]</span>
  <span class="n">expected</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">os</span> <span class="o">==</span> <span class="s2">&quot;osx&quot;</span><span class="p">:</span> <span class="n">FAIL</span>
    <span class="k">if</span> <span class="n">os</span> <span class="o">==</span> <span class="s2">&quot;windows&quot;</span> <span class="ow">and</span> <span class="n">version</span> <span class="o">==</span> <span class="s2">&quot;XP&quot;</span><span class="p">:</span> <span class="n">FAIL</span>
    <span class="n">PASS</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">PASS</span></code> in the above works, but is unnecessary; <code class="docutils literal notranslate"><span class="pre">PASS</span></code>
(or <code class="docutils literal notranslate"><span class="pre">OK</span></code>) is always the default expectation for (sub)tests.</p>
<p>A manifest with fuzzy reftest values might be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">reftest</span><span class="o">.</span><span class="n">html</span><span class="p">]</span>
  <span class="n">fuzzy</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">;</span><span class="mi">200</span><span class="p">,</span> <span class="n">ref1</span><span class="o">.</span><span class="n">html</span><span class="p">:</span><span class="mi">20</span><span class="p">;</span><span class="mi">200</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="n">subtest1</span><span class="o">.</span><span class="n">html</span><span class="o">==</span><span class="n">ref2</span><span class="o">.</span><span class="n">html</span><span class="p">:</span><span class="mi">10</span><span class="o">-</span><span class="mi">15</span><span class="p">;</span><span class="mi">20</span><span class="p">]</span>
</pre></div>
</div>
<p>In this case the default fuzziness for any comparison would be to
require a maximum difference per channel of less than or equal to 10
and less than or equal to 200 total pixels different. For any
comparison involving ref1.html on the right hand side, the limits
would instead be a difference per channel not more than 20 and a total
difference count of not less than 200 and not more than 300. For the
specific comparison subtest1.html == ref2.html (both resolved against
the test URL) these limits would instead be 10 to 15 and 0 to 20,
respectively.</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">web-platform-tests</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../test-suite-design.html">Test Suite Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../running-tests/index.html">Running Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../writing-tests/index.html">Writing Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reviewing-tests/index.html">Reviewing Tests</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../admin/index.html">Project Administration</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../../admin/index.html#tooling">Tooling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../admin/index.html#secrets">Secrets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../admin/index.html#third-party-account-owners">Third-party account owners</a></li>
</ul>
</li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../admin/index.html">Project Administration</a><ul>
  <li><a href="../README.html">wptrunner: A web-platform-tests harness</a><ul>
      <li>Previous: <a href="usage.html" title="previous chapter">Getting Started</a></li>
      <li>Next: <a href="design.html" title="next chapter">wptrunner Design</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, wpt contributors.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../../_sources/tools/wptrunner/docs/expectation.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>