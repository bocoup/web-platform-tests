<!doctype html>
<meta charset="utf-8">
<script>
/**
 * In order to assert that an error event does not fire, each sub-test in this
 * file intentionally causes three uncaught exceptions. The is used to trigger
 * the event in those browsers that incorrectly implement it. The second and
 * third are used to determine when the test is complete (that is: when it is
 * acceptable to stop waiting for the incorrect event) by scheduling additional
 * tasks in the same task queues.
 */
'use strict';

var isChild = false;
try {
  isChild = parent !== window && parent.location.href == window.location.href;
} catch (err) {}

if (isChild) {
  throw new Error('first error');
}
</script>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<body>
<script>
'use strict';

if (isChild) {
  onerror = function() {
    parent.postMessage('from identical location', '*');
  };
  throw new Error('second error');
}

setup({
  allow_uncaught_exception: true
});
async_test(function(t) {
  var iframe = document.createElement('iframe');

  window.addEventListener('error', function(event) {
    if (event.error.message === 'from distinct location') {
      t.done();
    }
  });
  window.addEventListener('message', function(event) {
    if (event.data == 'from distinct location') {
      throw new Error(event.data);
    }
  });

  iframe.onerror = t.step_func(function() {
    assert_unreached(
      'The "error" event should not be triggered (`onerror` property)'
    );
  });
  iframe.addEventListener('error', t.step_func(function() {
    assert_unreached(
      'The "error" event should not be triggered (`error` event handler)'
    );
  }));

  iframe.setAttribute('src', 'https://web-platform.test:8443/html/semantics/embedded-content/the-iframe-element/support/iframe-that-throws.html');
  document.body.appendChild(iframe);
}, 'iframe with distinct location');

async_test(function(t) {
  var iframe = document.createElement('iframe');

  window.addEventListener('error', function(event) {
    if (event.error.message === 'from identical location') {
      t.done();
    }
  });
  window.addEventListener('message', function(event) {
    if (event.data == 'from identical location') {
      throw new Error(event.data);
    }
  });

  iframe.onerror = t.step_func(function() {
    assert_unreached(
      'The "error" event should not be triggered (`onerror` property)'
    );
  });
  iframe.addEventListener('error', t.step_func(function() {
    assert_unreached(
      'The "error" event should not be triggered (`error` event handler)'
    );
  }));

  iframe.setAttribute('src', location.href);
  document.body.appendChild(iframe);
}, 'iframe with identical location');
</script>
</body>
