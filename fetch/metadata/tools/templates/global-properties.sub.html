<!DOCTYPE html>
<!-- This test was procedurally generated. Please do not modify it directly. -->
<html lang="en">
  <meta charset="utf-8">
  {#- Jinja2 models list values using generators. In order to count the number
      of members, the generator must be exhausted. Store the list values so
      that they may be iterated over to generate source code for subtests. #}
  {%- set foo = subtests|list %}
  {%- if foo|length > 10 %}
  <meta name="timeout" content="long">
  {%- endif %}
  <title>[%title%]</title>
  <script src="/resources/testharness.js"></script>
  <script src="/resources/testharnessreport.js"></script>
  <body>
  <script>
  'use strict';

  function induceRequest(path, navigate) {
    const win = window.open();
    const fullPath = path +
      `&body=<script>opener.postMessage('done', '*')</${''}script>`;

    return new Promise((resolve) => {
        addEventListener('message', function(event) {
          if (event.source === win) {
            resolve();
          }
        });

        navigate(win, fullPath);
      })
      .then(() => win.close());
  }
  {%- for subtest in foo %}

  promise_test(() => {
    const path = '/fetch/metadata/resources/record-headers.py?key={{uuid()}}';
    const navigate = (win, path) => {
      {%- if subtest.api in ['location', 'location.href'] %}
      win.[%subtest.api%] = path;
      {%- else %}
      win.[%subtest.api%](path);
      {%- endif %}
    };
    return induceRequest('[%subtest.pathPrefix%]' + path, navigate)
      .then(() => fetch(path + '&retrieve'))
      .then((response) => response.text())
      .then((text) => JSON.parse(text))
      .then((headers) => {
        {%- if subtest[expected] == none %}
          assert_not_own_property(headers, '[%headerName%]');
        {%- else %}
          assert_own_property(headers, '[%headerName%]');
          assert_equals(headers['[%headerName%]'], '[%subtest.expected%]');
        {%- endif %}
        });
  }, '[%headerName%] - [%subtest.description%]');

  {%- endfor %}
  </script>
  </body>
</html>
