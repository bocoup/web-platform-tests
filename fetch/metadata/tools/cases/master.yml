---
- title: Fetch Metadata - Sec-Fetch-Site - redirection from HTTP
  fileName: sec-fetch-site
  headerName: sec-fetch-site
  all_subtests:
    - description: HTTPS downgrade-upgrade
      pathPrefix: "\
        https://{{host}}:{{ports[https][0]}}/fetch/api/resources/redirect.py?location=\
        http://{{host}}:{{ports[http][0]}}/fetch/api/resources/redirect.py?location=\
        https://{{host}}:{{ports[https][0]}}"
      expected: cross-site
  each_subtest:
    appcache-manifest.sub.https.html: [{}]
    fetch.sub.html: [{}]
    font.sub.html: [{}]
    form-submission.sub.html:
      - description: ' - GET'
        method: GET
      - description: ' - POST'
        method: POST
    global-properties.sub.html:
      - description: ' - location'
        api: location
      - description: ' - location.href'
        api: location.href
      - description: ' - location.assign'
        api: location.assign
      - description: ' - location.replace'
        api: location.replace
    image.sub.html: [{}]
    script-element.sub.html:
      - description: ' - classic script'
      - description: ' - module script'
        elementAttrs:
          type: module
    script-module-import-dynamic.sub.html: [{}]
    script-module-import-static.sub.html: [{}]
    video-poster.sub.html: [{}]

- title: Fetch Metadata - Sec-Fetch-Site - redirection from HTTPS
  fileName: sec-fetch-site.https
  headerName: sec-fetch-site
  all_subtests:
    - description: Same-Origin -> Cross-Site -> Same-Origin redirect
      pathPrefix: "\
        https://{{host}}:{{ports[https][0]}}/fetch/api/resources/redirect.py?location=\
        https://{{hosts[alt][www]}}:{{ports[https][0]}}/fetch/api/resources/redirect.py?location=\
        https://{{host}}:{{ports[https][0]}}"
      expected: cross-site
  each_subtest:
    appcache-manifest.sub.https.html: [{}]
    fetch.sub.html: [{ init: { mode: no-cors } }]
    font.sub.html: [{}]
    form-submission.sub.html:
      - description: ' - GET'
        method: GET
      - description: ' - POST'
        method: POST
    global-properties.sub.html:
      - description: ' - location'
        api: location
      - description: ' - location.href'
        api: location.href
      - description: ' - location.assign'
        api: location.assign
      - description: ' - location.replace'
        api: location.replace
    image.sub.html: [{}]
    script-element.sub.html:
      - description: ' - classic script'
      - description: ' - module script'
        elementAttrs:
          type: module
    script-module-import-dynamic.sub.html: [{}]
    script-module-import-static.sub.html: [{}]
    video-poster.sub.html: [{}]

- title: Fetch Metadata - Sec-Fetch-Site - redirection with mixed content
  # These tests verify the effect that redirection has on the request's "site".
  # The initial request must be made to a resource that is "same-site" with its
  # origin. This avoids false positives because if the request were made to a
  # cross-site resource, the value of "cross-site" would be assigned regardless
  # of the subseqent redirection.
  #
  # Because these conditions necessarily warrant mixed content, only templates
  # which can be configured to allow mixed content [1] can be used.
  #
  # [1] https://w3c.github.io/webappsec-mixed-content/#should-block-fetch
  fileName: sec-fetch-site-mixed.https
  headerName: sec-fetch-site
  all_subtests:
    - description: HTTPS downgrade-upgrade
      pathPrefix: "\
        https://{{host}}:{{ports[https][0]}}/fetch/api/resources/redirect.py?location=\
        http://{{host}}:{{ports[http][0]}}/fetch/api/resources/redirect.py?location=\
        https://{{host}}:{{ports[https][0]}}"
      expected: cross-site
  each_subtest:
    appcache-manifest.sub.https.html: [{}]
    form-submission.sub.html:
      - description: ' - GET'
        method: GET
      - description: ' - POST'
        method: POST
    global-properties.sub.html:
      - description: ' - location'
        api: location
      - description: ' - location.href'
        api: location.href
      - description: ' - location.assign'
        api: location.assign
      - description: ' - location.replace'
        api: location.replace
    image.sub.html: [{}]
    video-poster.sub.html: [{}]

- title: Fetch Metadata - Sec-Fetch-Mode
  # These tests are served over HTTPS so the induced requests will be both
  # same-origin with the document [1] and a potentially-trustworthy URL [2].
  #
  # [1] https://html.spec.whatwg.org/multipage/origin.html#same-origin
  # [2] https://w3c.github.io/webappsec-secure-contexts/#potentially-trustworthy-url
  fileName: sec-fetch-mode.https
  headerName: sec-fetch-mode
  each_subtest:
    appcache-manifest.sub.https.html:
      - expected: no-cors
    fetch.sub.html:
      - description: no options
        expected: cors
      - description: 'mode: cors'
        expected: cors
        init: { mode: cors }
      - description: 'mode: no-cors'
        expected: no-cors
        init: { mode: no-cors }
      - description: 'mode: same-origin'
        expected: same-origin
        init: { mode: same-origin }
    font.sub.html:
      - expected: cors
    form-submission.sub.html:
      - description: GET
        method: GET
        expected: navigate
      - description: POST
        method: POST
        expected: navigate
    global-properties.sub.html:
      - description: location
        api: location
        expected: navigate
      - description: location.href
        api: location.href
        expected: navigate
      - description: location.assign
        api: location.assign
        expected: navigate
      - description: location.replace
        api: location.replace
        expected: navigate
    image.sub.html:
      - description: no attributes
        expected: no-cors
      - description: crossorigin=""
        expected: cors
        elementAttrs:
          crossorigin: ''
      - description: crossorigin="anonymous"
        expected: cors
        elementAttrs:
          crossorigin: anonymous
      - description: crossorigin="use-credentials"
        expected: cors
        elementAttrs:
          crossorigin: use-credentials
    script-element.sub.html:
      - description: classic script
        expected: no-cors
      - description: module script
        expected: cors
        elementAttrs:
          type: module
      - description: classic script, crossorigin=""
        expected: cors
        elementAttrs:
          crossorigin: ''
      - description: classic script, crossorigin="anonymous"
        expected: cors
        elementAttrs:
          crossorigin: anonymous
      - description: classic script, crossorigin="use-credentials"
        expected: cors
        elementAttrs:
          crossorigin: use-credentials
    script-module-import-dynamic.sub.html:
      - expected: cors
    script-module-import-static.sub.html:
      - expected: cors
    video-poster.sub.html:
      - expected: no-cors
